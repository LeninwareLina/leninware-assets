# main.py

from youtube_virality_worker import run_virality_pass
from transcript_fetcher import fetch_transcript

from leninware_commentary import generate_leninware_commentary
from script_safety_filter import apply_script_safety_filter

from storyboard_prompt_generator import generate_storyboard_prompts
from safe_image_prompt_filter import apply_safe_substitutions
from image_generator import generate_images_from_prompts

from leninware_video_pipeline import create_leninware_video
from youtube_uploader import upload_video


def main():
    print("\n=== Leninware Pipeline Starting ===\n")

    # 1. Run virality worker
    candidates = run_virality_pass()
    if not candidates:
        print("[main] No viral videos found.")
        return

    candidate = candidates[0]
    url = candidate.get("url")
    title = candidate.get("title", "Untitled Video")
    channel = candidate.get("channel", "Unknown Channel")

    print(f"[main] Selected candidate:")
    print(f"   Title: {title}")
    print(f"   Channel: {channel}")
    print(f"   URL: {url}")

    # 2. Get transcript
    print("\n[main] Fetching transcript...")
    transcript = fetch_transcript(url)
    if not transcript:
        print("[main] Transcript not available. Skipping.")
        return

    # 3. Generate Leninware commentary
    print("\n[main] Generating Leninware commentary...")
    raw_commentary = generate_leninware_commentary(transcript)

    # 4. Safety filter for narration
    print("\n[main] Running script safety filter...")
    safe_commentary = apply_script_safety_filter(raw_commentary)

    # 5. Storyboard prompts (GPT-mini)
    print("\n[main] Generating storyboard prompts...")
    storyboard_prompts = generate_storyboard_prompts(
        safe_commentary,
        num_images=8,
    )

    # 6. Optional string-rule safety for YouTube compliance
    print("\n[main] Applying substitution rules to prompts...")
    final_prompts = apply_safe_substitutions(storyboard_prompts)

    # 7. Generate images (OpenAI)
    print("\n[main] Generating images from storyboard prompts...")
    image_paths = generate_images_from_prompts(final_prompts)

    # 8. Create final video with Shotstack
    print("\n[main] Creating final video...")
    video_path = create_leninware_video(
        safe_script_text=safe_commentary,
        image_paths=image_paths,
    )

    # 9. Upload to YouTube
    print("\n[main] Uploading video to YouTube...")
    upload_title = f"Leninware reacts: {title}"
    upload_description = (
        f"Automated Leninware commentary on '{title}' "
        f"from channel '{channel}'.\n\n"
        "Generated by Leninware AI."
    )

    upload_video(
        video_path,
        title=upload_title,
        description=upload_description,
    )

    print("\n=== Leninware Pipeline Complete ===\n")


if __name__ == "__main__":
    main()