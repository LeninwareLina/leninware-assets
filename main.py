# main.py

raise SystemExit("RUNNING MAIN FROM: " + __file__)

from youtube_ingest import get_recent_candidates
from youtube_virality_worker import run_virality_pass
from transcript_fetcher import fetch_transcript

from leninware_commentary import generate_leninware_commentary
from script_safety_filter import apply_script_safety_filter

from storyboard_prompt_generator import generate_storyboard_prompts
from safe_image_prompt_filter import apply_safe_substitutions
from image_generator import generate_images_from_prompts

from audio_generator import generate_tts_audio
from leninware_video_pipeline import create_leninware_video

from youtube_uploader import upload_video


def main():
    print("\n===== Leninware Pipeline Starting =====\n")

    # ---------------------------------------------------
    # 1. INGEST RECENT VIDEOS (SHORTS FILTER APPLIED)
    # ---------------------------------------------------
    print("[main] Fetching recent candidates...")
    candidates = get_recent_candidates(max_results=5)

    if not candidates:
        print("[main] No recent long-form videos found.")
        return

    # ---------------------------------------------------
    # 2. VIRALITY RANKING
    # ---------------------------------------------------
    print("[main] Running virality pass...")
    viral_list = run_virality_pass(candidates)

    if not viral_list:
        print("[main] No videos with usable stats.")
        return

    print("\n[main] Virality ranking:")
    for v in viral_list:
        print(f"  {v['title']} â€” score={v['virality']}")

    # ---------------------------------------------------
    # 3. FIND FIRST VIDEO WITH AVAILABLE TRANSCRIPT
    # ---------------------------------------------------
    selected = None
    transcript_text = None

    for v in viral_list:
        print(f"\n[main] Checking transcript availability for: {v['title']}")
        tr = fetch_transcript(v["video_id"])
        if tr:
            transcript_text = tr
            selected = v
            break

    if not selected:
        print("[main] No videos with available transcripts.")
        return

    print(f"\n[main] Selected video:\n    Title: {selected['title']}\n    URL: {selected['url']}\n")

    # ---------------------------------------------------
    # 4. LENINWARE COMMENTARY
    # ---------------------------------------------------
    print("[main] Generating Leninware commentary...")
    raw_commentary = generate_leninware_commentary(transcript_text)

    # ---------------------------------------------------
    # 5. SAFETY FILTER
    # ---------------------------------------------------
    print("[main] Applying script safety filter...")
    safe_script = apply_script_safety_filter(raw_commentary)

    # ---------------------------------------------------
    # 6. STORYBOARD PROMPTS
    # ---------------------------------------------------
    print("[main] Generating storyboard prompts...")
    storyboard_prompts = generate_storyboard_prompts(safe_script)

    print("[main] Applying substitution safety filter...")
    safe_prompts = apply_safe_substitutions(storyboard_prompts)

    # ---------------------------------------------------
    # 7. IMAGE GENERATION
    # ---------------------------------------------------
    print("[main] Generating images from prompts...")
    image_paths = generate_images_from_prompts(safe_prompts)

    # ---------------------------------------------------
    # 8. AUDIO (TTS)
    # ---------------------------------------------------
    print("[main] Generating TTS audio...")
    audio_path = generate_tts_audio(safe_script)

    # ---------------------------------------------------
    # 9. SHOTSTACK VIDEO RENDER
    # ---------------------------------------------------
    print("[main] Rendering final Leninware video...")
    video_path = create_leninware_video(
        script_text=safe_script,
        image_paths=image_paths,
        audio_path=audio_path
    )

    print(f"[main] Render complete: {video_path}")

    # ---------------------------------------------------
    # 10. UPLOAD TO YOUTUBE
    # ---------------------------------------------------
    upload_title = f"Leninware Reacts: {selected['title']}"
    upload_description = (
        f"Automated Leninware reaction to: {selected['title']}\n"
        f"Original video: {selected['url']}\n\n"
        "Generated by Leninware AI."
    )

    print("[main] Uploading to YouTube...")
    upload_video(
        video_path,
        title=upload_title,
        description=upload_description,
    )

    print("\n===== Leninware Pipeline Complete =====\n")


if __name__ == "__main__":
    main()